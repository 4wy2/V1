<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฅุฏุงุฑุฉ ูุงุฏู ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ | EEC Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Cairo', sans-serif; background-color: #020617; color: #f8fafc; }
        .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .heatmap-cell { height: 45px; transition: all 0.3s; border-radius: 10px; font-size: 12px; font-weight: 800; }
        .student-card { transition: 0.2s; cursor: pointer; border-right: 4px solid transparent; background: rgba(30, 41, 59, 0.5); }
        .student-card:hover { background: rgba(51, 65, 85, 0.8); }
        .student-card.selected { background: rgba(37, 99, 235, 0.2) !important; border-right-color: #3b82f6; }
        
        .mode-btn { padding: 10px 24px; border-radius: 14px; font-size: 13px; font-weight: 800; transition: 0.3s; }
        .mode-btn.active { background: #2563eb; color: white; box-shadow: 0 4px 20px rgba(37, 99, 235, 0.4); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #1e293b; border-radius: 10px; }
        
        @media (max-width: 768px) {
            .heatmap-cell { height: 38px; font-size: 10px; }
        }
    </style>
</head>
<body class="antialiased p-4 md:p-8">

    <div id="loginOverlay" class="fixed inset-0 z-[200] bg-slate-950 flex items-center justify-center p-6">
        <div class="glass p-10 rounded-[2.5rem] text-center w-full max-w-sm shadow-2xl">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-6 text-2xl shadow-lg rotate-3">โก</div>
            <h2 class="text-xl font-black mb-6">ุฑูุฒ ุฏุฎูู ุงูุฅุฏุงุฑุฉ</h2>
            <input type="password" id="adminPass" class="w-full p-4 rounded-2xl bg-slate-950 border border-slate-800 text-center mb-4 outline-none focus:ring-2 ring-blue-500 font-mono text-2xl tracking-widest text-white">
            <button onclick="checkAuth()" class="w-full bg-blue-600 p-4 rounded-2xl font-black hover:bg-blue-700 transition shadow-lg shadow-blue-900/20">ุชุฃููุฏ ุงูุฏุฎูู</button>
        </div>
    </div>

    <div id="mainContent" class="hidden max-w-7xl mx-auto space-y-8">
        
        <header class="flex flex-col md:flex-row justify-between items-center gap-6">
            <div>
                <h1 class="text-3xl font-black text-white tracking-tight">ูุธุงู ุชุญููู ุงูุชูุฑุบ ุงูุฐูู <span class="text-blue-500">EEC</span></h1>
                <p class="text-slate-400 text-sm mt-1 font-semibold">ููุญุฉ ุชุญูู ุงููุงุฏุฉ - ูุงุฏู ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ</p>
            </div>
            
            <div class="flex bg-slate-900/50 p-1.5 rounded-2xl border border-slate-800 gap-2 backdrop-blur-md">
                <button id="btnGlobal" onclick="setMode('global')" class="mode-btn active">ุงูุฅุญุตุงุก ุงูุนุงู ๐</button>
                <button id="btnGroup" onclick="setMode('group')" class="mode-btn text-slate-400">ุชุญููู ุงููุฌููุนุงุช ๐ฅ</button>
            </div>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass p-5 rounded-3xl border border-white/5">
                <span class="text-[10px] font-black text-slate-500 uppercase block mb-1">ุฅุฌูุงูู ุงูุทูุงุจ</span>
                <span id="statTotal" class="text-2xl font-black text-white">0</span>
            </div>
            <div class="glass p-5 rounded-3xl border border-white/5">
                <span class="text-[10px] font-black text-slate-500 uppercase block mb-1">ุฃุนูู ูุซุงูุฉ</span>
                <span id="statMax" class="text-2xl font-black text-emerald-500">0</span>
            </div>
            <div id="groupStats" class="hidden md:block glass p-5 rounded-3xl border border-blue-500/20 bg-blue-500/5">
                <span class="text-[10px] font-black text-blue-400 uppercase block mb-1">ุงููุฎุชุงุฑูู ูููุฌููุนุฉ</span>
                <span id="statSelected" class="text-2xl font-black text-white">0</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <div class="lg:col-span-4 flex flex-col gap-4">
                <div class="glass p-6 rounded-[2.5rem] shadow-xl h-[600px] flex flex-col">
                    <div class="space-y-4 mb-6">
                        <div class="relative">
                            <input type="text" id="searchBox" oninput="filterStudents()" placeholder="ุงุจุญุซ ุจุงูุงุณู..." 
                                   class="w-full bg-slate-950 p-4 pr-12 rounded-2xl border border-slate-800 outline-none focus:border-blue-500 text-sm font-bold text-white">
                            <span class="absolute right-4 top-1/2 -translate-y-1/2 opacity-30 text-lg">๐</span>
                        </div>
                        <select id="majorFilter" onchange="filterStudents()" class="w-full bg-slate-950 p-3 rounded-xl border border-slate-800 text-xs font-bold outline-none text-blue-400">
                            <option value="all">ูู ุงูุฃูุณุงู ๐</option>
                            <option value="ุงูููุฑุจุงุฆูุฉ">ุงูููุฏุณุฉ ุงูููุฑุจุงุฆูุฉ (EE) โก</option>
                            <option value="ุงูููู">ุชูููุฉ ุงูููู ุงูููุฑุจุงุฆูุฉ (EPT) ๐</option>
                            <option value="ุงูุงุชุตุงูุงุช">ุชูููุฉ ุงูุฅููุชุฑูููุงุช ูุงูุงุชุตุงูุงุช ๐ก</option>
                            <option value="ุงูุงูุงุช">ุชูููุฉ ุงูุขูุงุช ุงูุฏูููุฉ ูุงูุชุญูู (ICT) โ๏ธ</option>
                            <option value="ุงููููุงุชุฑููููุณ">ุชูููุฉ ุงููููุงุชุฑููููุณ (mechT) ๐ฆพ</option>
                        </select>
                    </div>

                    <div id="studentsList" class="overflow-y-auto space-y-3 pr-2 flex-grow custom-scrollbar"></div>
                    
                    <button onclick="clearSelection()" class="mt-4 text-[11px] font-black text-slate-500 hover:text-red-400 transition-all text-center border-t border-white/5 pt-4">
                        ุฅุนุงุฏุฉ ุชุนููู ูุงูุฉ ุงูุงุฎุชูุงุฑุงุช โบ
                    </button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div class="glass p-8 rounded-[3rem] shadow-xl h-full border border-white/5">
                    <div class="flex justify-between items-start mb-10">
                        <div>
                            <h3 id="gridTitle" class="text-2xl font-black text-white tracking-tight">ุงูุฅุญุตุงุก ุงูุนุงู</h3>
                            <p id="gridSubtitle" class="text-xs text-slate-500 font-bold mt-1 uppercase tracking-widest">ุชูุฒูุน ุงููุซุงูุฉ ุงูุนุฏุฏูุฉ ููู ุณุงุนุฉ</p>
                        </div>
                        <div id="selectionBadge" class="hidden bg-blue-600 text-white px-5 py-2 rounded-2xl text-[10px] font-black animate-pulse shadow-lg shadow-blue-900/40">
                            ููุท ุงููุฌููุนุฉ ูุดุท
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <div id="heatmap-grid" class="grid grid-cols-6 gap-3 min-w-[600px]"></div>
                    </div>

                    <div class="mt-12 pt-8 border-t border-slate-800/50 flex flex-wrap gap-8 justify-center">
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 bg-slate-800/50 rounded-md border border-white/5"></div>
                            <span class="text-[11px] font-black text-slate-400">ูุง ููุฌุฏ ูุชูุฑุบูู</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 bg-emerald-500/30 rounded-md"></div>
                            <span class="text-[11px] font-black text-slate-400">ุชูุฑุบ ููุฎูุถ</span>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="w-4 h-4 bg-emerald-500 rounded-md shadow-[0_0_15px_rgba(16,185,129,0.4)]"></div>
                            <span class="text-[11px] font-black text-slate-400">ุฐุฑูุฉ ุงูุชูุฑุบ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://zakzkcxyxntvlsvywmii.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpha3prY3h5eG50dmxzdnl3bWlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwODY1NDIsImV4cCI6MjA4NDY2MjU0Mn0.hApvnHyFsm5SBPUWdJ0AHrjMmxYrihXhEq9P_Knp-vY';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allData = [];
        let selectedIDs = new Set();
        let currentMode = 'global';

        // ุฏุงูุฉ ุชูุธูู ุงููุตูุต ุงูุนุฑุจูุฉ ูุถูุงู ุงูููุชุฑุฉ ุงูุตุญูุญุฉ
        const normalize = (text) => {
            if (!text) return "";
            return text.toString()
                .replace(/[ุฃุฅุข]/g, 'ุง')
                .replace(/\s+/g, ' ')
                .trim();
        };

        function checkAuth() {
            if(document.getElementById('adminPass').value === "9653") {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                fetchData();
            } else {
                alert("ุงูุฑูุฒ ุบูุฑ ุตุญูุญ");
            }
        }

        async function fetchData() {
            const { data } = await _supabase.from('club_availability').select('*').order('created_at', { ascending: false });
            allData = data || [];
            document.getElementById('statTotal').innerText = allData.length;
            filterStudents(); // ุชุดุบูู ุงูููุชุฑุฉ ุงูุฃูููุฉ
        }

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnGlobal').classList.toggle('active', mode === 'global');
            document.getElementById('btnGroup').classList.toggle('active', mode === 'group');
            document.getElementById('btnGlobal').classList.toggle('text-slate-400', mode !== 'global');
            document.getElementById('btnGroup').classList.toggle('text-slate-400', mode !== 'group');
            
            if(mode === 'global') {
                selectedIDs.clear();
                document.getElementById('selectionBadge').classList.add('hidden');
                document.getElementById('groupStats').classList.add('hidden');
            } else {
                document.getElementById('selectionBadge').classList.remove('hidden');
                document.getElementById('groupStats').classList.remove('hidden');
            }
            updateView();
        }

        function toggleStudent(name) {
            if (currentMode !== 'group') return;
            if (selectedIDs.has(name)) selectedIDs.delete(name);
            else selectedIDs.add(name);
            updateView();
        }

        function updateView() {
            document.querySelectorAll('.student-card').forEach(card => {
                const name = card.id.replace('card-', '');
                card.classList.toggle('selected', selectedIDs.has(name));
            });

            document.getElementById('statSelected').innerText = selectedIDs.size;
            
            // ููุชุฑุฉ ุงูุจูุงูุงุช ุจูุงุกู ุนูู ุงููุฌููุนุฉ ุงููุฎุชุงุฑุฉ ุฃู ุงููู
            const displayData = (currentMode === 'group' && selectedIDs.size > 0) 
                ? allData.filter(s => selectedIDs.has(s.student_name)) 
                : getFilteredList(); // ุงุณุชุฎุฏุงู ุงููุงุฆูุฉ ุงููููุชุฑุฉ ุญุงููุงู ูู ุงูููุท ุงูุนุงู

            if (currentMode === 'group' && selectedIDs.size > 0) {
                document.getElementById('gridTitle').innerText = "ุชุญููู ุงููุฌููุนุฉ";
                document.getElementById('gridSubtitle').innerText = `ุงููุดุงุฑูุฉ ุงููุดุชุฑูุฉ ูู ${selectedIDs.size} ุทุงูุจุงู`;
                renderHeatmap(displayData, true);
            } else {
                document.getElementById('gridTitle').innerText = "ุงูุฅุญุตุงุก ุงูุนุงู";
                document.getElementById('gridSubtitle').innerText = "ุชูุฒูุน ุงููุซุงูุฉ ุงูุนุฏุฏูุฉ ุงูุดุงูู";
                renderHeatmap(displayData, false);
            }
        }

        function getFilteredList() {
            const term = normalize(document.getElementById('searchBox').value.toLowerCase());
            const major = normalize(document.getElementById('majorFilter').value);
            
            return allData.filter(s => {
                const nameMatch = normalize(s.student_name).toLowerCase().includes(term);
                const majorMatch = (document.getElementById('majorFilter').value === 'all') || normalize(s.student_major).includes(major);
                return nameMatch && majorMatch;
            });
        }

        function filterStudents() {
            const filtered = getFilteredList();
            renderStudentsList(filtered);
            updateView();
        }

        function clearSelection() {
            selectedIDs.clear();
            updateView();
        }

        function renderStudentsList(students) {
            const list = document.getElementById('studentsList');
            list.innerHTML = students.map(s => `
                <div onclick="toggleStudent('${s.student_name}')" id="card-${s.student_name}" 
                     class="student-card p-4 rounded-2xl border border-white/5 flex flex-col gap-1">
                    <p class="text-sm font-black text-blue-400">${s.student_name}</p>
                    <div class="flex justify-between items-center">
                        <p class="text-[10px] text-slate-500 font-bold uppercase">${s.student_major || 'ุนุงู'}</p>
                        <span class="text-[9px] bg-white/5 px-2 py-1 rounded-lg text-slate-400 italic">${s.slots_data.length} ุณุงุนุฉ</span>
                    </div>
                </div>
            `).join('');
        }

        function renderHeatmap(data, isGroup = false) {
            const grid = document.getElementById('heatmap-grid');
            const DAYS = ["ุงูุฃุญุฏ", "ุงูุงุซููู", "ุงูุซูุงุซุงุก", "ุงูุฃุฑุจุนุงุก", "ุงูุฎููุณ"];
            const SLOTS = ["08-09", "09-10", "10-11", "11-12", "12-01", "01-02", "02-03", "03-04", "04-05", "05-06", "06-07"];
            const stats = Array(11).fill(0).map(() => Array(5).fill(0));
            let maxVal = 0;

            data.forEach(sub => {
                sub.slots_data.forEach(item => {
                    stats[item.slot][item.day]++;
                    if (stats[item.slot][item.day] > maxVal) maxVal = stats[item.slot][item.day];
                });
            });

            document.getElementById('statMax').innerText = maxVal;

            let html = `<div class="p-3 text-center text-[10px] font-black text-slate-600 uppercase italic">ุงูููุช</div>`;
            DAYS.forEach(d => html += `<div class="p-3 text-center text-[11px] font-black text-slate-400">${d}</div>`);

            SLOTS.forEach((time, sIdx) => {
                html += `<div class="flex items-center justify-center bg-slate-900/50 text-[10px] font-black rounded-xl text-slate-500 border border-white/5">${time}</div>`;
                for (let dIdx = 0; dIdx < 5; dIdx++) {
                    const val = stats[sIdx][dIdx];
                    let intensity = val === 0 ? 0.05 : (val / (maxVal || 1));
                    let color = isGroup ? `rgba(37, 99, 235, ${intensity})` : `rgba(16, 185, 129, ${intensity})`;
                    
                    html += `<div class="heatmap-cell flex items-center justify-center border border-white/5 relative group" 
                                 style="background: ${val > 0 ? color : 'rgba(30,41,59,0.2)'}; 
                                        box-shadow: ${val === maxVal && val > 0 ? 'inset 0 0 15px rgba(255,255,255,0.1)' : 'none'}">
                                <span class="${val > 0 ? 'text-white' : 'text-slate-800'} z-10">${val > 0 ? val : ''}</span>
                                ${val === maxVal && val > 0 ? '<span class="absolute -top-1 -right-1 text-[8px]">โญ</span>' : ''}
                             </div>`;
                }
            });
            grid.innerHTML = html;
        }
    </script>
</body>
</html>
